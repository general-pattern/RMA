{% extends "base.html" %}
{% block content %}

<div class="page-header">
  <h2>ðŸ“‹ My Dashboard</h2>
</div>

{% if not is_owner %}
<div class="card">
  <div class="empty-state">
    <p>You are not configured as an internal owner.</p>
    <p>Contact your administrator to set up owner access.</p>
  </div>
</div>
{% else %}

<!-- Summary Stats -->
<div class="stats-grid" style="margin-bottom: 30px;">
  <div class="stat-card stat-total">
    <div class="stat-number">{{ stats.total }}</div>
    <div class="stat-label">Assigned to Me</div>
  </div>
  
  <div class="stat-card {% if stats.urgent > 0 %}stat-urgent{% else %}stat-pending{% endif %}">
    <div class="stat-number">{{ stats.urgent }}</div>
    <div class="stat-label">Urgent (>14 days)</div>
  </div>
  
  <div class="stat-card {% if stats.warning > 0 %}stat-open{% else %}stat-pending{% endif %}">
    <div class="stat-number">{{ stats.warning }}</div>
    <div class="stat-label">Warning (7-14 days)</div>
  </div>
  
  <div class="stat-card stat-info">
    <div class="stat-number">{{ stats.normal }}</div>
    <div class="stat-label">Normal (<7 days)</div>
  </div>
</div>

<!-- My RMAs -->
<div class="card">
  <div class="card-header">
    <h3>My Assigned RMAs ({{ my_rmas|length }})</h3>
    <span style="color: var(--gray-500); font-size: 13px; font-weight: normal;">
      Sorted by age (oldest first)
    </span>
  </div>
  
  {% if my_rmas %}
  <div style="padding: 0;">
    {% for r in my_rmas %}
    {% set days_open = (r['DateOpened']|time_active(r['DateClosed'], r['Status'])) %}
    {% set days_num = days_open.replace('days', '').replace('day', '').replace('weeks', '').replace('week', '').replace('months', '').replace('month', '').replace('h', '').strip()|int if days_open else 0 %}
    
    <div class="rma-dashboard-item {% if loop.index != my_rmas|length %}rma-dashboard-border{% endif %}">
      <div class="rma-dashboard-header">
        <div style="display: flex; align-items: center; gap: 10px;">
          <!-- Urgency Indicator -->
          {% if 'week' in days_open or 'month' in days_open %}
            {% if 'month' in days_open or days_num >= 2 %}
              <span class="urgency-badge urgency-urgent">ðŸ”´ URGENT</span>
            {% else %}
              <span class="urgency-badge urgency-warning">ðŸŸ¡ WARNING</span>
            {% endif %}
          {% else %}
            <span class="urgency-badge urgency-normal">ðŸŸ¢ NORMAL</span>
          {% endif %}
          
          <!-- RMA Code -->
          <a href="{{ url_for('view_rma', rma_id=r['RMAID']) }}" class="rma-dashboard-code">
            {{ r['RMAID']|rma_code }}
          </a>
          
          <!-- Customer -->
          <span class="rma-dashboard-customer">{{ r['CustomerName'] }}</span>
          
          <!-- Status Badge -->
          <span class="status-badge status-{{ r['Status']|lower|replace(' ', '-') }}">
            {{ r['Status'] }}
          </span>
          
          {% if r['IsPrimary'] %}
            <span class="primary-badge">PRIMARY</span>
          {% endif %}
        </div>
        
        <!-- Time Active -->
        <div style="display: flex; align-items: center; gap: 15px;">
          <span class="time-active-badge">{{ days_open }}</span>
          <a href="{{ url_for('view_rma', rma_id=r['RMAID']) }}" class="btn-secondary btn-sm">View</a>
        </div>
      </div>
      
      <!-- Complaint -->
      {% if r['CustomerComplaintDesc'] %}
      <div class="rma-dashboard-complaint">
        {{ r['CustomerComplaintDesc']|truncate(150) }}
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  
  {% else %}
  <div class="empty-state">
    <p>ðŸŽ‰ You have no open RMAs assigned!</p>
    <p style="color: var(--gray-500); font-size: 14px;">
      New RMAs will appear here when assigned to you.
    </p>
  </div>
  {% endif %}
</div>

<!-- Quick Actions -->
<div style="margin-top: 20px; display: flex; gap: 10px;">
  <a href="{{ url_for('list_rmas') }}" class="btn-secondary">View All RMAs</a>
  <a href="{{ url_for('profile') }}" class="btn-secondary">Notification Settings</a>
</div>

{% endif %}

<style>
/* Dashboard Stats */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  border: 2px solid var(--gray-200);
  text-align: center;
  transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.stat-number {
  font-size: 32px;
  font-weight: 700;
  color: var(--gray-800);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 13px;
  color: var(--gray-600);
  font-weight: 500;
}

.stat-urgent {
  border-color: #dc2626;
  background: #fef2f2;
}

.stat-urgent .stat-number {
  color: #dc2626;
}

/* Dashboard RMA Items */
.rma-dashboard-item {
  padding: 20px;
  transition: background-color 0.15s;
}

.rma-dashboard-item:hover {
  background-color: var(--gray-50);
}

.rma-dashboard-border {
  border-bottom: 1px solid var(--gray-200);
}

.rma-dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
  gap: 10px;
}

.rma-dashboard-code {
  font-weight: 700;
  font-size: 16px;
  color: var(--primary);
  text-decoration: none;
}

.rma-dashboard-code:hover {
  text-decoration: underline;
}

.rma-dashboard-customer {
  color: var(--gray-700);
  font-weight: 500;
}

.rma-dashboard-complaint {
  color: var(--gray-600);
  font-size: 14px;
  line-height: 1.5;
  margin-top: 8px;
  padding-left: 0px;
}

/* Urgency Badges */
.urgency-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.urgency-urgent {
  background-color: #fee2e2;
  color: #991b1b;
}

.urgency-warning {
  background-color: #fef3c7;
  color: #92400e;
}

.urgency-normal {
  background-color: #d1fae5;
  color: #065f46;
}

/* Time Active Badge */
.time-active-badge {
  background-color: var(--gray-100);
  color: var(--gray-700);
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 13px;
  font-weight: 600;
}

/* Primary Badge */
.primary-badge {
  background-color: #dbeafe;
  color: #1e40af;
  padding: 2px 8px;
  border-radius: 3px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

/* Button Small */
.btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}
</style>

{% endblock %}
