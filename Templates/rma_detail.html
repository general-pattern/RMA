{% extends "base.html" %}
{% block content %}

<div class="rma-header">
  <div class="rma-title">
    <h2>{{ rma['RMAID']|rma_code }} - {{ rma['CustomerName'] }}</h2>
    <span class="status-badge status-{{ rma['Status']|lower|replace(' ', '-') }}">{{ rma['Status'] }}</span>
  </div>
  <div class="rma-actions">
    <form action="{{ url_for('delete_rma', rma_id=rma['RMAID']) }}" method="post" class="inline-form"
          onsubmit="return confirm('Delete this RMA?');">
      <button type="submit" class="btn-danger">üóëÔ∏è Delete</button>
    </form>
  </div>
</div>

<!-- Status Update Card -->
<div class="card status-card">
  <form method="post" action="{{ url_for('update_status', rma_id=rma['RMAID']) }}" class="status-form">
    <label>Update Status:</label>
    <select name="status">
      {% for s in status_options %}
      <option value="{{ s }}" {% if rma['Status'] == s %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
    <input type="text" name="comment" placeholder="Comment (optional)">
    <button type="submit" class="btn-primary">Update</button>
  </form>
</div>

<!-- Header Card -->
<div class="card {% if edit_mode %}card-editing{% endif %}">
  <div class="card-header">
    <h3>RMA Information</h3>
    {% if not edit_mode %}
    <a href="{{ url_for('view_rma', rma_id=rma['RMAID'], edit='1') }}" class="btn-icon">‚úèÔ∏è</a>
    {% else %}
    <a href="{{ url_for('view_rma', rma_id=rma['RMAID']) }}" class="btn-icon">‚úñÔ∏è</a>
    {% endif %}
  </div>
  
  {% if edit_mode %}
  <form method="post" action="{{ url_for('edit_rma_inline', rma_id=rma['RMAID']) }}">
    <div class="form-grid">
      <div class="form-group">
        <label>Customer</label>
        <select name="customer_id" required>
          {% for c in customers %}
          <option value="{{ c['CustomerID'] }}" {% if c['CustomerID'] == rma['CustomerID'] %}selected{% endif %}>{{ c['CustomerName'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select name="status">
          {% for s in status_options %}
          <option value="{{ s }}" {% if rma['Status'] == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Return Type</label>
        <select name="return_type">
          <option value="TBD" {% if rma['ReturnType'] == 'TBD' %}selected{% endif %}>TBD</option>
          <option value="Credit" {% if rma['ReturnType'] == 'Credit' %}selected{% endif %}>Credit</option>
          <option value="Replacement" {% if rma['ReturnType'] == 'Replacement' %}selected{% endif %}>Replacement</option>
          <option value="Repair and Return" {% if rma['ReturnType'] == 'Repair and Return' %}selected{% endif %}>Repair and Return</option>
        </select>
      </div>
      <div class="form-group">
        <label>Internal Owner</label>
        <select name="owner_id">
          <option value="">-- None --</option>
          {% for o in owners %}
          <option value="{{ o['OwnerID'] }}" {% if o['OwnerID'] == rma['InternalOwnerID'] %}selected{% endif %}>{{ o['OwnerName'] }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Credit Memo #</label>
        <input type="text" name="credit_memo" value="{{ rma['CreditMemoNumber'] or '' }}" placeholder="Optional">
      </div>
    </div>
    <div class="form-group">
      <label>Customer Complaint</label>
      <textarea name="complaint" rows="3">{{ rma['CustomerComplaintDesc'] or '' }}</textarea>
    </div>
    <div class="form-group">
      <label>Internal Notes</label>
      <textarea name="internal_notes" rows="3">{{ rma['InternalNotes'] or '' }}</textarea>
    </div>
    <div class="form-actions">
      <button type="submit" class="btn-primary">Save</button>
      <a href="{{ url_for('view_rma', rma_id=rma['RMAID']) }}" class="btn-secondary">Cancel</a>
    </div>
  </form>
  {% else %}
    <div class="info-grid">
    <div class="info-item">
      <span class="info-label">Customer</span>
      <span class="info-value">{{ rma['CustomerName'] }}</span>
    </div>
    <div class="info-item">
      <span class="info-label">Return Type</span>
      <span class="info-value">{{ rma['ReturnType'] or '-' }}</span>
    </div>
    <div class="info-item">
      <span class="info-label">Created By</span>
      <span class="info-value">{{ rma['CreatedByName'] or '-' }}</span>
    </div>
    <div class="info-item">
      <span class="info-label">Date Opened</span>
      <span class="info-value">{{ rma['DateOpened']|short_date }}</span>
    </div>
    
    <!-- Multiple Owners Section -->
    <div class="info-item" style="grid-column: 1 / -1; border-top: 2px solid var(--gray-200); margin-top: 10px; padding-top: 15px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span class="info-label" style="font-size: 16px; font-weight: 600;">Assigned Owners</span>
        <button type="button" onclick="document.getElementById('add-owner-form').style.display='block'" class="btn-secondary" style="padding: 6px 12px; font-size: 13px;">
          ‚ûï Add Owner
        </button>
      </div>
      
      {% if assigned_owners %}
        <div style="display: flex; flex-direction: column; gap: 10px;">
          {% for ao in assigned_owners %}
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background-color: {% if ao['IsPrimary'] %}#dbeafe{% else %}var(--gray-50){% endif %}; border-radius: 6px; border-left: 4px solid {% if ao['IsPrimary'] %}var(--primary){% else %}var(--gray-300){% endif %};">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-weight: 600; color: var(--gray-800);">{{ ao['OwnerName'] }}</span>
              {% if ao['IsPrimary'] %}
              <span style="background-color: #1e40af; color: white; padding: 2px 8px; border-radius: 3px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px;">PRIMARY</span>
              {% endif %}
            </div>
            <div style="display: flex; gap: 8px;">
              {% if not ao['IsPrimary'] %}
              <form method="POST" action="{{ url_for('change_primary_owner', rma_id=rma['RMAID']) }}" style="display: inline;">
                <input type="hidden" name="owner_id" value="{{ ao['OwnerID'] }}">
                <button type="submit" class="btn-secondary" style="padding: 4px 10px; font-size: 12px;">
                  Make Primary
                </button>
              </form>
              <form method="POST" action="{{ url_for('remove_rma_owner', rma_id=rma['RMAID'], owner_id=ao['OwnerID']) }}" style="display: inline;" onsubmit="return confirm('Remove this owner?');">
                <button type="submit" class="btn-secondary" style="padding: 4px 10px; font-size: 12px; color: #dc2626;">
                  Remove
                </button>
              </form>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p style="color: var(--gray-500); font-style: italic;">No owners assigned yet.</p>
      {% endif %}
      
      <!-- Add Owner Form (hidden by default) -->
      <div id="add-owner-form" style="display: none; margin-top: 15px; padding: 15px; background-color: #f0f9ff; border-radius: 6px; border: 2px solid var(--primary);">
        <form method="POST" action="{{ url_for('add_rma_owner', rma_id=rma['RMAID']) }}">
          <div style="display: flex; gap: 10px; align-items: flex-end;">
            <div style="flex: 1;">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--gray-700);">Select Owner</label>
              <select name="owner_id" required style="width: 100%; padding: 8px; border: 1px solid var(--gray-300); border-radius: 4px;">
                <option value="">-- Select an owner --</option>
                {% for o in owners %}
                <option value="{{ o['OwnerID'] }}">{{ o['OwnerName'] }}</option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="btn-primary" style="padding: 8px 16px;">Add</button>
            <button type="button" onclick="document.getElementById('add-owner-form').style.display='none'" class="btn-secondary" style="padding: 8px 16px;">Cancel</button>
          </div>
        </form>
      </div>
    </div>
    
    <div class="info-item">
      <span class="info-label">Time Active</span>
      <span class="info-value" style="font-weight: 600; color: var(--primary);">
        {{ rma['DateOpened']|time_active(rma['DateClosed'], rma['Status']) }}
      </span>
    </div>
    {% if rma['Status'] in ['Closed', 'Rejected'] %}
    <div class="info-item">
      <span class="info-label">{{ 'Closed' if rma['Status'] == 'Closed' else 'Rejected' }}</span>
      <span class="info-value">
        {{ rma['DateClosed']|short_date }} by {{ rma['ClosedBy'] }}
      </span>
    </div>
    {% endif %}
    
    <div class="info-item">
      <span class="info-label">Credit Memo #</span>
      <span class="info-value">{{ rma['CreditMemoNumber'] or '-' }}</span>
    </div>

    <!-- Acknowledged box -->
    <div class="info-item">
      <span class="info-label">Acknowledged</span>
      <span class="info-value">
        {% if rma['Acknowledged'] %}
          <span class="ack-yes">‚úì Yes</span>
          {% if rma['AcknowledgedOn'] %}
          <span class="notes-meta">({{ rma['AcknowledgedOn']|short_date }})</span>
          {% endif %}
        {% else %}
          <span class="ack-no">‚úó No</span>
          {% if rma['InternalOwnerID'] %}
          <form method="post"
                action="{{ url_for('acknowledge_rma', rma_id=rma['RMAID']) }}"
                class="inline-form"
                style="display:inline;">
            <button type="submit"
                    class="btn-sm btn-secondary"
                    style="margin-left:6px;">
              Mark Acknowledged
            </button>
          </form>
          {% endif %}
        {% endif %}
      </span>
    </div>
    
    <!-- Credit Approved box -->
    <div class="info-item">
      <span class="info-label">Credit Approved</span>
      <span class="info-value">
        {% if rma['CreditApproved'] %}
          <span class="ack-yes">‚úì Yes</span>
          {% if rma['CreditApprovedOn'] %}
          <span class="notes-meta">({{ rma['CreditApprovedOn']|short_date }} by {{ rma['CreditApprovedBy'] }})</span>
          {% endif %}
        {% else %}
          <span class="ack-no">‚úó No</span>
        {% endif %}
        <form method="post"
              action="{{ url_for('approve_credit', rma_id=rma['RMAID']) }}"
              class="inline-form"
              style="display:inline;">
          <button type="submit"
                  class="btn-sm btn-secondary"
                  style="margin-left:6px;">
            {% if rma['CreditApproved'] %}Remove Approval{% else %}Approve Credit{% endif %}
          </button>
        </form>
      </span>
    </div>
  </div>
  <div class="info-section">
    <h4>Customer Complaint</h4>
    <div class="text-block">{{ rma['CustomerComplaintDesc'] or 'No complaint.' }}</div>
  </div>
  <div class="info-section">
    <div class="notes-header">
      <h4>Internal Notes</h4>
      {% if notes_history %}
      <a href="{{ url_for('view_rma', rma_id=rma['RMAID'], notes_history='1') }}" class="btn-sm btn-secondary">üìú History ({{ notes_history|length }})</a>
      {% endif %}
    </div>
    <div class="text-block">{{ rma['InternalNotes'] or 'No notes.' }}</div>
    {% if rma['NotesLastModified'] %}
    <div class="notes-meta">Last modified: {{ rma['NotesLastModified'] }} by {{ rma['NotesModifiedBy'] }}</div>
    {% endif %}
  </div>
  {% endif %}
</div>



{% if show_notes_history and notes_history %}
<div class="card">
  <div class="card-header">
    <h3>üìú Notes History</h3>
    <a href="{{ url_for('view_rma', rma_id=rma['RMAID']) }}" class="btn-icon">‚úñÔ∏è</a>
  </div>
  {% for note in notes_history %}
  <div class="history-item">
    <div class="history-meta"><strong>{{ note['ModifiedBy'] }}</strong> - {{ note['ModifiedOn'] }}</div>
    <div class="history-content">{{ note['NotesContent'] }}</div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Line Items -->
<div class="card">
  <div class="card-header"><h3>Line Items</h3></div>
  {% if lines %}
  <table>
    <thead>
      <tr><th>Part #</th><th>Tool #</th><th>Description</th><th>Qty</th><th>PO/Lot</th><th>Cost</th><th>Disp.</th><th></th></tr>
    </thead>
    <tbody>
      {% for line in lines %}
      <tr>
        {% if edit_line == line['RMALineID'] %}
        <form method="post" action="{{ url_for('edit_line', rma_id=rma['RMAID'], line_id=line['RMALineID']) }}">
          <td><input type="text" name="part_number" value="{{ line['PartNumber'] or '' }}" style="width:80px"></td>
          <td><input type="text" name="tool_number" value="{{ line['ToolNumber'] or '' }}" style="width:80px"></td>
          <td><input type="text" name="item_description" value="{{ line['ItemDescription'] or '' }}" style="width:120px"></td>
          <td><input type="number" name="qty_affected" value="{{ line['QtyAffected'] or '' }}" style="width:50px"></td>
          <td><input type="text" name="po_lot_number" value="{{ line['POLotNumber'] or '' }}" style="width:80px"></td>
          <td><input type="number" step="0.01" name="total_cost" value="{{ line['TotalCost'] or '' }}" style="width:70px"></td>
          <td>-</td>
          <td><button type="submit" class="btn-sm btn-primary">Save</button></td>
        </form>
        {% else %}
        <td>{{ line['PartNumber'] or '-' }}</td>
        <td>{{ line['ToolNumber'] or '-' }}</td>
        <td>{{ line['ItemDescription'] or '-' }}</td>
        <td>{{ line['QtyAffected'] or '-' }}</td>
        <td>{{ line['POLotNumber'] or '-' }}</td>
        <td>{{ line['TotalCost']|currency }}</td>
        <td>{% if line['Disposition'] %}<span class="disposition-badge">{{ line['Disposition'] }}</span>{% else %}-{% endif %}</td>
        <td>
          <a href="{{ url_for('view_rma', rma_id=rma['RMAID'], edit_line=line['RMALineID']) }}">‚úèÔ∏è</a>
          <form method="post" action="{{ url_for('delete_line', rma_id=rma['RMAID'], line_id=line['RMALineID']) }}" class="inline-form" onsubmit="return confirm('Delete?');">
            <button type="submit" class="btn-link">üóëÔ∏è</button>
          </form>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
  <h4 style="margin-top:15px;">Add Line</h4>
  <form method="post" action="{{ url_for('add_line', rma_id=rma['RMAID']) }}" class="add-line-form">
    <input type="text" name="part_number" placeholder="Part #" required>
    <input type="text" name="tool_number" placeholder="Tool #">
    <input type="text" name="item_description" placeholder="Description">
    <input type="number" name="qty_affected" placeholder="Qty">
    <input type="text" name="po_lot_number" placeholder="PO/Lot">
    <input type="number" step="0.01" name="total_cost" placeholder="Cost">
    <button type="submit" class="btn-primary">Add</button>
  </form>
</div>

<!-- Dispositions -->
{% if lines %}
<div class="card">
  <div class="card-header"><h3>Dispositions</h3></div>
  {% for line in lines %}
  <div class="disposition-block">
    <h4>{{ line['PartNumber'] or 'Item' }} {% if line['ItemDescription'] %}- {{ line['ItemDescription'] }}{% endif %}</h4>
    <form method="post" action="{{ url_for('add_disposition', rma_id=rma['RMAID'], line_id=line['RMALineID']) }}">
      <div class="disposition-grid">
        <div class="form-group"><label>Disposition</label>
          <select name="disposition">
            <option value="">--</option>
            <option value="Scrap" {% if line['Disposition'] == 'Scrap' %}selected{% endif %}>Scrap</option>
            <option value="Rework" {% if line['Disposition'] == 'Rework' %}selected{% endif %}>Rework</option>
            <option value="Replace" {% if line['Disposition'] == 'Replace' %}selected{% endif %}>Replace</option>
            <option value="Return to Customer" {% if line['Disposition'] == 'Return to Customer' %}selected{% endif %}>Return to Customer</option>
            <option value="No Fault Found" {% if line['Disposition'] == 'No Fault Found' %}selected{% endif %}>No Fault Found</option>
            <option value="Credit" {% if line['Disposition'] == 'Credit' %}selected{% endif %}>Credit</option>
          </select>
        </div>
        <div class="form-group"><label>Failure Code</label><input type="text" name="failure_code" value="{{ line['FailureCode'] or '' }}"></div>
        <div class="form-group"><label>Qty Scrap</label><input type="number" name="qty_scrap" value="{{ line['QtyScrap'] or '' }}"></div>
        <div class="form-group"><label>Qty Rework</label><input type="number" name="qty_rework" value="{{ line['QtyRework'] or '' }}"></div>
        <div class="form-group"><label>Qty Replace</label><input type="number" name="qty_replace" value="{{ line['QtyReplace'] or '' }}"></div>
      </div>
      <div class="form-group"><label>Failure Description</label><textarea name="failure_description" rows="2">{{ line['FailureDescription'] or '' }}</textarea></div>
      <div class="form-group"><label>Root Cause</label><textarea name="root_cause" rows="2">{{ line['RootCause'] or '' }}</textarea></div>
      <div class="form-group"><label>Corrective Action</label><textarea name="corrective_action" rows="2">{{ line['CorrectiveAction'] or '' }}</textarea></div>
      <button type="submit" class="btn-primary">Save Disposition</button>
      {% if line['DateDispositioned'] %}<span class="notes-meta">Last: {{ line['DateDispositioned'] }} by {{ line['DispositionBy'] }}</span>{% endif %}
    </form>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Status History -->
<div class="card">
  <div class="card-header"><h3>Status History</h3></div>
  {% if statuses %}
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Status</th>
        <th>By</th>
        <th>Comment</th>
        <th></th>  {# actions column #}
      </tr>
    </thead>
    <tbody>
      {% for s in statuses %}
      <tr>
        <td>{{ s['ChangedOn']|short_date }}</td>
        <td>
          <span class="status-badge status-{{ s['Status']|lower|replace(' ', '-') }}">
            {{ s['Status'] }}
          </span>
        </td>
        <td>{{ s['ChangedBy'] or '-' }}</td>
        <td>{{ s['Comment'] or '-' }}</td>
        <td>
          <form method="post"
                action="{{ url_for('delete_status_history_entry',
                                   rma_id=rma['RMAID'],
                                   history_id=s['StatusHistID']) }}"
                class="inline-form"
                onsubmit="return confirm('Delete this status history entry?');">
            <button type="submit" class="btn-link" title="Delete status history entry">üóëÔ∏è</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
</div>


<!-- Attachments -->
<div class="card">
  <div class="card-header"><h3>Attachments</h3></div>

  {% if attachments %}
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>File</th>
        <th>Added By</th>
        <th>Date</th>
        <th></th>  <!-- actions -->
      </tr>
    </thead>
    <tbody>
      {% for a in attachments %}
      {% set fname = a['FilePath'].split('/')[-1].split('\\')[-1] %}
      <tr>
        <td>{{ a['AttachmentType'] }}</td>
        <td>
          <a href="{{ url_for('uploaded_file', rma_id=rma['RMAID'], filename=fname) }}" target="_blank">
            {{ fname }}
          </a>
        </td>
        <td>{{ a['AddedBy'] }}</td>
        <td>{{ a['DateAdded']|short_date }}</td>
        <td>
          <form method="post"
                action="{{ url_for('delete_attachment', rma_id=rma['RMAID'], attachment_id=a['AttachmentID']) }}"
                class="inline-form"
                onsubmit="return confirm('Delete this attachment?');">
            <button type="submit" class="btn-link" title="Delete attachment">üóëÔ∏è</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}

  <h4 style="margin-top:15px;">Upload</h4>
  <form method="post"
        action="{{ url_for('add_attachment', rma_id=rma['RMAID']) }}"
        enctype="multipart/form-data"
        class="upload-form">
    <input type="file" name="file" required>
    <button type="submit" class="btn-primary">Upload</button>
  </form>
</div>

{% endblock %}
