{% extends "base.html" %}
{% block content %}

<div class="page-header">
  <h2>RMAs</h2>
  <a href="{{ url_for('new_rma') }}" class="btn-primary">➕ New RMA</a>
</div>

<!-- Search & Filter Form -->
<div class="card filter-card">
  <form method="get" action="{{ url_for('list_rmas') }}" class="filter-form">
    <div class="filter-grid">
      <div class="filter-group">
        <label>Search</label>
        <input type="text" name="search" placeholder="RMA #, customer, owner..." 
               value="{{ current_search or '' }}">
      </div>
      
      <div class="filter-group">
        <label>Status</label>
        <select name="status">
          <option value="">All Statuses</option>
          {% for s in status_options %}
          <option value="{{ s }}" {% if current_status == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label>Return Type</label>
        <select name="return_type">
          <option value="">All Types</option>
          <option value="Credit" {% if current_return_type == 'Credit' %}selected{% endif %}>Credit</option>
          <option value="Replacement" {% if current_return_type == 'Replacement' %}selected{% endif %}>Replacement</option>
          <option value="Repair and Return" {% if current_return_type == 'Repair and Return' %}selected{% endif %}>Repair and Return</option>
          <option value="TBD" {% if current_return_type == 'TBD' %}selected{% endif %}>TBD</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Customer</label>
        <select name="customer_id">
          <option value="">All Customers</option>
          {% for c in customers %}
          <option value="{{ c['CustomerID'] }}" {% if current_customer == c['CustomerID']|string %}selected{% endif %}>
            {{ c['CustomerName'] }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label>Owner</label>
        <select name="owner_id">
          <option value="">All Owners</option>
          {% for o in owners %}
          <option value="{{ o['OwnerID'] }}" {% if current_owner == o['OwnerID']|string %}selected{% endif %}>
            {{ o['OwnerName'] }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label>From Date</label>
        <input type="date" name="date_from" value="{{ current_date_from or '' }}">
      </div>
      
      <div class="filter-group">
        <label>To Date</label>
        <input type="date" name="date_to" value="{{ current_date_to or '' }}">
      </div>
      
      <div class="filter-group">
        <label>Credit Approved</label>
        <select name="credit_approved">
          <option value="">All</option>
          <option value="1" {% if current_credit_approved == '1' %}selected{% endif %}>Yes</option>
          <option value="0" {% if current_credit_approved == '0' %}selected{% endif %}>No</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Disposition Status</label>
        <select name="disposition_status">
          <option value="">All</option>
          <option value="completed" {% if current_disposition_status == 'completed' %}selected{% endif %}>Completed</option>
          <option value="pending" {% if current_disposition_status == 'pending' %}selected{% endif %}>Pending</option>
        </select>
      </div>
      
      <div class="filter-group filter-actions">
        <button type="submit" class="btn-primary">Search</button>
        <a href="{{ url_for('list_rmas') }}" class="btn-secondary">Clear</a>
      </div>
    </div>
  </form>
</div>

<!-- Results -->
<div class="card">
  <p class="results-count">Found {{ rmas|length }} RMA(s)</p>
  
  {% if rmas %}
  <table>
    <thead>
      <tr>
        <th>RMA #</th>
        <th>Customer</th>
        <th>Date Opened</th>
        <th>Time Active</th>
        <th>Status</th>
        <th>Return Type</th>
        <th>Owner</th>
        <th>Credit Approved</th>
        <th>Credit Memo #</th>
        <th>Disposition</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rmas %}
      <tr>
        <td>
          <a href="{{ url_for('view_rma', rma_id=r['RMAID']) }}" class="rma-link">
            {{ r['RMAID']|rma_code }}
          </a>
        </td>
        <td>{{ r['CustomerName'] }}</td>
        <td>{{ r['DateOpened']|short_date }}</td>
        <td style="font-weight: 600; color: var(--primary);">
          {{ r['DateOpened']|time_active(r['DateClosed'], r['Status']) }}
        </td>
        <td>
          <span class="status-badge status-{{ r['Status']|lower|replace(' ', '-') }}">
            {{ r['Status'] }}
          </span>
        </td>
        <td>{{ r['ReturnType'] or '-' }}</td>
        <td>{{ r['OwnerName'] or '-' }}</td>
        <td>
          {% if r['CreditApproved'] %}
            <span class="ack-yes">✓</span>
          {% else %}
            <span class="ack-no">✗</span>
          {% endif %}
        </td>
        <td>{{ r['CreditMemoNumber'] or '-' }}</td>
        <td>
          {% if r['has_disposition'] %}
            <span class="ack-yes">✓</span>
          {% else %}
            <span class="text-muted">-</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="empty-state">
    <p>No RMAs found matching your criteria.</p>
  </div>
  {% endif %}
</div>

{% endblock %}
